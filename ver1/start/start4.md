## mermaid vs graphviz

Похоже mermaid не поддерживает встраивание картинок. Тогда вместо mermaid используй библиотеку graphviz (dot).


Мы получили два важных уточнения от пользователя. Во-первых, он хочет использовать <br> для переноса строк вместо \n. Во-вторых, он считает, что Mermaid не поддерживает встраивание картинок, и предлагает перейти на Graphviz (dot).

Нужно оценить ситуацию. Из предыдущей переписки и результатов поиска видно, что Mermaid действительно может отображать HTML внутри узлов при включенных опциях htmlLabels: true и securityLevel: 'loose' . Мы это уже использовали в коде для вставки фото через <foreignObject>. Однако это работает только при рендеринге на странице, но не при экспорте в mermaid.live, и требует дополнительной кастомизации после рендера.

Главная проблема, с которой столкнулся пользователь, — что ссылка на mermaid.live ведёт на схему без фото и с неправильным переносом. Это потому, что в код экспорта мы вставляли \n, а Mermaid ожидает либо \n, либо HTML-теги, но для экспорта в live editor HTML может не поддерживаться.

Поэтому предложение пользователя перейти на Graphviz (dot) — разумное решение, если цель — получить самодостаточную диаграмму со встроенными изображениями, которую можно открыть в любом месте.

Из результатов поиска мы видим:

Есть библиотека kingraph, которая строит семейные деревья на основе YAML и экспортирует в Graphviz 

Существуют способы интеграции Graphviz с JavaScript через WebAssembly (например, hpcc-js-wasm) 

Библиотека parenthood парсит простой текстовый формат и генерирует dot-код 

Это подтверждает, что Graphviz — подходящий инструмент.

Теперь задача: переписать программу с Mermaid на Graphviz. Нужно:

Сохранить загрузку Excel, парсинг данных.

Генерировать код на языке DOT.

Использовать JavaScript-библиотеку для рендеринга DOT в SVG/HTML.

Встроить изображения в узлы — в Graphviz для этого есть механизм HTML-подобных меток (узлы формы shape=none и label=<<TABLE>...</TABLE>>).

Обеспечить перенос строк с помощью <BR/>.

Сделать ссылку на просмотр в онлайн-редакторе Graphviz (например, на viz-js.com), используя сжатие.

План действий:

Заменить Mermaid на библиотеку @hpcc-js/wasm или viz.js (или использовать d3-graphviz).

В коде генерации заменить синтаксис Mermaid на DOT.

Для фото: в DOT используем HTML-таблицы для размещения картинки слева и текста справа с переносом строк.

Для экспорта сжимаем DOT-код и формируем ссылку на http://viz-js.com (он принимает данные в URL через # как Graphviz).

Таким образом, пользователь получит полностью автономную диаграмму с фото, переносами строк и работающей ссылкой на онлайн-редактор.

### \n vs <BR/>
В Graphviz действительно существует **два различных синтаксиса** для переноса строк, и их важно различать:

| Тип метки | Синтаксис переноса | Пример |
|-----------|-------------------|--------|
| **Обычная строковая метка** (в кавычках) | `\n` | `label="Имя\n(1870-1924)"`  |
| **HTML-метка** (в `<>`) | `<BR/>` | `label=<Имя<BR/>(1870-1924)>`  |

## Что использовать в вашем случае

В текущей реализации вы используете **HTML-метки** (через `<TABLE>`), поэтому для переноса строк внутри ячеек таблицы можно применять:
- Либо структуру с двумя отдельными строками таблицы (как сделано сейчас)
- Либо внутри одной ячейки использовать `<BR/>` 

Вот как можно модифицировать код для использования `<BR/>` внутри одной ячейки:

```javascript
// Вместо текущей структуры с ROWSPAN:
`
<TABLE ...>
  <TR>
    <TD ROWSPAN="2"><IMG SRC="pic/${p.idA}.png" .../></TD>
    <TD>${p.label}</TD>
  </TR>
  <TR>
    <TD>${birthYear} – ${deathYear}</TD>
  </TR>
</TABLE>
`

// Можно использовать так (с <BR/> внутри одной ячейки):
`
<TABLE BORDER="0" CELLBORDER="1" CELLSPACING="0" CELLPADDING="4" BGCOLOR="${bgColor}" COLOR="${borderColor}">
  <TR>
    <TD WIDTH="45" HEIGHT="45" FIXEDSIZE="TRUE">
      <IMG SRC="pic/${p.idA}.png" SCALE="TRUE" WIDTH="45" HEIGHT="45"/>
    </TD>
    <TD>${p.label}<BR/>${birthYear} – ${deathYear}</TD>
  </TR>
</TABLE>
`
```

## Почему это важно

1. **Корректность синтаксиса**: Для HTML-меток в Graphviz используется именно `<BR/>` (или `<BR>`) для переноса строк .
2. **Совместимость**: Онлайн-редакторы (viz-js.com) правильно интерпретируют HTML-метки с `<BR/>`.
3. **Гибкость**: Такой подход позволяет комбинировать форматирование в одной ячейке.

Если вы хотите сохранить текущую структуру с двумя строками таблицы — это тоже рабочий вариант. Оба подхода корректны, просто выбор зависит от предпочтений в организации кода.
