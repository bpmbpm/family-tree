### table1.md 
продолжение

## Привязка групповых фото и событий к персонам в генеалогической базе на Excel

При разработке программы Family Tree на базе Excel вы сталкиваетесь с классической задачей организации связей «многие ко многим»: одно фото может содержать много персон, одна персона может быть на многих фото; аналогично для событий. В реляционных базах данных для этого используются промежуточные таблицы. В Excel тоже можно применить подобный подход, адаптировав его под возможности электронных таблиц.

Ниже представлены различные методики с подробным описанием, примерами структур листов, плюсами и минусами каждого варианта.

---

### Исходные данные (лист `Person`)

На листе `Person` каждая персона занимает одну строку. Обязательно наличие уникального идентификатора (ID). Пример структуры:

| PersonID | Фамилия | Имя   | Отчество | Пол | Отец (ID) | Мать (ID) | Дата_рождения | ... |
|----------|---------|-------|----------|-----|-----------|-----------|----------------|-----|
| 1        | Иванов  | Иван  | Петрович | М   | 3         | 4         | 01.01.1980     | ... |
| 2        | Иванова | Мария | Ивановна | Ж   | 5         | 6         | 05.03.1982     | ... |

**Ключевой момент:** все связи с другими объектами (фото, события) должны использовать `PersonID`.

---

## 1. Привязка групповых фото к персонам

### Вариант 1. Денормализованный подход (списки ID в одной ячейке)

На листе `Photo` создаётся поле `Persons`, где через разделитель (например, запятую) перечисляются ID персон, изображённых на фото.

**Структура листа `Photo`:**

| PhotoID | FileName   | Date       | Description | Persons (текст)   |
|---------|------------|------------|-------------|-------------------|
| 1       | wedding.jpg| 10.07.2020 | Свадьба     | 1,2,5,7           |
| 2       | family.jpg | 01.01.2021 | Семейный сбор | 1,2,3           |

**Плюсы:**
- Простота ввода данных.
- Компактность (не нужны дополнительные листы).

**Минусы:**
- Поиск фото, на которых присутствует конкретная персона, требует сложного текстового поиска (например, `=ПОИСК(","&PersonID&",", ","&[Persons]&",")`), что неудобно и медленно при больших объёмах.
- Нарушается нормализация: невозможно легко добавить дополнительные атрибуты связи (например, координаты лица на фото).
- Риск ошибок при ручном вводе (лишние пробелы, разные разделители).

**Вывод:** годится только для очень маленьких проектов с минимальными требованиями к поиску.

---

### Вариант 2. Нормализованный подход (связующая таблица)

Создаётся отдельный лист `PhotoPerson`, который реализует связь «многие ко многим». Каждая строка соответствует одному участию персоны в фото.

**Лист `Photo` (информация о фото):**

| PhotoID | FileName   | Date       | Description |
|---------|------------|------------|-------------|
| 1       | wedding.jpg| 10.07.2020 | Свадьба     |
| 2       | family.jpg | 01.01.2021 | Семейный сбор |

**Лист `PhotoPerson` (связи):**

| PhotoPersonID (опционально) | PhotoID | PersonID | Примечание (например, координаты) |
|-----------------------------|---------|----------|-----------------------------------|
| 1                           | 1       | 1        |                                   |
| 2                           | 1       | 2        |                                   |
| 3                           | 1       | 5        |                                   |
| 4                           | 2       | 1        |                                   |
| 5                           | 2       | 2        |                                   |

**Плюсы:**
- Полная гибкость: можно добавлять любые поля для конкретной связи (например, координаты лица на фото, роль на фото).
- Простой и быстрый поиск через фильтры или функции ВПР/ПРОСМОТРX.
- Лёгкость добавления и удаления участников фото.
- Возможность построения отчётов и сводных таблиц.

**Минусы:**
- Увеличение числа листов и строк.
- Необходимость поддержки целостности ссылок (например, чтобы не было PhotoID, отсутствующего в листе `Photo`).

---

### Вариант 3. Гибридный подход (связь через текстовые идентификаторы с использованием формул)

Можно оставить поле `Persons` в листе `Photo` в виде списка ID, но дополнительно создать «умную» связующую таблицу, которая автоматически разворачивает этот список в нормализованную форму с помощью формул или Power Query. Однако для пользователя это сложнее.

---

## 2. Привязка событий к персонам

События (рождение, смерть, брак, крещение и т.п.) также могут затрагивать несколько персон. Например, в браке участвуют двое, в похоронах — множество. Аналогично фото, лучше использовать нормализованную схему.

### Структура для событий

**Лист `Event`:**

| EventID | EventType | Date       | Place       | Description      |
|---------|-----------|------------|-------------|------------------|
| 1       | Рождение  | 01.01.1980 | Роддом №1   | Запись в книге   |
| 2       | Брак      | 10.07.2020 | ЗАГС        |                  |
| 3       | Похороны  | 05.03.2022 | Кладбище    |                  |

**Лист `EventPerson` (участники событий):**

| EventPersonID | EventID | PersonID | Role          |
|---------------|---------|----------|---------------|
| 1             | 1       | 1        | Младенец      |
| 2             | 1       | 3        | Отец          |
| 3             | 1       | 4        | Мать          |
| 4             | 2       | 1        | Жених         |
| 5             | 2       | 2        | Невеста       |
| 6             | 2       | 5        | Свидетель     |
| 7             | 3       | 2        | Умерший       |
| 8             | 3       | 1        | Присутствовал |
| ...           |         |          |               |

Поле `Role` позволяет уточнить роль персоны в событии (необязательно, но полезно).

**Плюсы:**
- Чёткое разделение информации о событии и его участниках.
- Возможность добавления разных ролей.
- Простота выборки: все события для персоны, все участники события.

---

## 3. Система тегов для фото

Теги (ключевые слова) для фото — ещё одна сущность, которая может быть связана с фото через «многие ко многим». Аналогично создаются листы:

**Лист `Tag`:**

| TagID | TagName  |
|-------|----------|
| 1     | Свадьба  |
| 2     | Портрет  |
| 3     | Отдых    |

**Лист `PhotoTag`:**

| PhotoTagID | PhotoID | TagID |
|------------|---------|-------|
| 1          | 1       | 1     |
| 2          | 1       | 2     |
| 3          | 2       | 3     |

---

## 4. Организация работы в Excel

### 4.1. Использование таблиц Excel

Превратите каждый лист с данными в «умную таблицу» (Ctrl+T). Это даст:
- Автоматическое расширение диапазонов при добавлении строк.
- Именованные ссылки на столбцы, удобные для формул.
- Возможность использовать структурированные ссылки (например, `Photo[PhotoID]`).

### 4.2. Создание уникальных идентификаторов

Используйте простую нумерацию (1,2,3…). При добавлении новых строк можно применять формулу `=МАКС([ID])+1` или, если таблица, то просто вводить следующее число.

### 4.3. Обеспечение целостности данных

- Для полей `PhotoID`, `PersonID`, `EventID` в связующих таблицах можно использовать проверку данных (меню «Данные» → «Проверка данных» → тип «Список»), чтобы выбирать значения из соответствующих листов.
- Это предотвратит ввод несуществующих ID.

### 4.4. Примеры запросов

#### Найти все фото, на которых есть персона с ID=1

Используем лист `PhotoPerson`. Отфильтруйте его по `PersonID=1`, затем по полученным `PhotoID` найдите описания в листе `Photo` с помощью ВПР.

Можно также создать формулу массива (для одной ячейки), но проще использовать промежуточные вычисления или сводную таблицу.

#### Для вывода списка персон на конкретном фото (PhotoID=1) на отдельном листе

Создайте выпадающий список с PhotoID, а рядом формулу, которая вытягивает имена персон через `ФИЛЬТР` (если есть Excel 365):

```
=ОБЪЕДИНИТЬ(", ";ИСТИНА;ВПР(ФИЛЬТР(PhotoPerson[PersonID];PhotoPerson[PhotoID]=A1);Person[#Все];2;ЛОЖЬ))
```

Более старый способ: используйте вспомогательный столбец в `PhotoPerson`, который через ВПР подтягивает имя, а затем фильтруйте.

### 4.5. Использование Power Query для сложных отчётов

Если данные большие, можно загрузить все листы в Power Query, объединить связи и выгружать готовые отчёты на отдельные листы. Это мощный, но требующий изучения инструмент.

---

## 5. Рекомендации по выбору подхода

- **Для небольших проектов** (до 100 персон, до 50 фото) допустим денормализованный подход со списками ID, если поиск не критичен.
- **Для средних и больших проектов** (более 100 персон, активное использование) обязателен нормализованный подход с отдельными связующими таблицами.
- Если планируется расширение функциональности (например, указание лиц на фото, разные роли в событиях), нормализация незаменима.

**Важно:** не пытайтесь хранить все связи в одной ячейке на листе `Person` (например, поле «Фото» со списком PhotoID). Это приведёт к дублированию и сложностям при редактировании.

---

## 6. Пример итоговой структуры листов

1. **Person** – персоны.
2. **Photo** – фотографии.
3. **PhotoPerson** – связь фото и персон.
4. **Event** – события.
5. **EventPerson** – связь событий и персон (с ролью).
6. **Tag** – теги.
7. **PhotoTag** – связь фото и тегов.

Дополнительно можно создать листы для мест (Place) и источников (Source) и аналогично связать их.

---

## Заключение

Описанная методика с использованием связующих таблиц (листов) полностью решает задачу привязки групповых фото и событий к персонам в среде Excel. Она соответствует принципам нормализации данных, обеспечивает гибкость, простоту поиска и возможность дальнейшего расширения. Применение «умных таблиц» и проверки данных повышает удобство и надёжность работы.

Вы можете реализовать эту структуру прямо сейчас, создав соответствующие листы в вашей книге Excel и начав ввод данных. Для удобства ввода можно разработать простые формы на VBA, но это уже следующий шаг.
