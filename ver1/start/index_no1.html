<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–µ–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ (Mermaid)</title>
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.6.0/dist/mermaid.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .toolbar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        button { padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #1e2b37; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        #fileInput { display: none; }
        .status { padding: 10px 15px; background: #fff8e5; border-left: 5px solid #f1c40f; margin-bottom: 20px; }
        .mermaid-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow-x: auto; min-height: 500px; }
        .mermaid-container svg { max-width: 100%; height: auto; margin: 0 auto; display: block; }
        footer { margin-top: 25px; text-align: center; color: #5d6d7e; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå≥ –°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ —Å —Ñ–æ—Ç–æ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫</h1>
        <div class="toolbar">
            <button id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å tree.xlsx</button>
            <button id="manualBtn">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            <button id="mermaidLiveBtn" disabled>üîó –û—Ç–∫—Ä—ã—Ç—å –≤ mermaid.live</button>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
        </div>
        <div id="status" class="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...</div>
        <div id="mermaidContainer" class="mermaid-container">–î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –∑–¥–µ—Å—å...</div>
        <footer>–§–æ—Ç–æ –∏–∑ –ø–∞–ø–∫–∏ <code>pic/</code> (idA.png). –î–ª—è –º—É–∂—á–∏–Ω —Ä–∞–º–∫–∞ —Å–∏–Ω—è—è, –¥–ª—è –∂–µ–Ω—â–∏–Ω ‚Äî —Ä–æ–∑–æ–≤–∞—è. –ì–æ–¥—ã –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.</footer>
    </div>
    <script>
        (function() {
            let people = [];
            let rawMermaidCode = '';
            const mermaidLiveBtn = document.getElementById('mermaidLiveBtn');
            const statusDiv = document.getElementById('status');
            const container = document.getElementById('mermaidContainer');
            const loadBtn = document.getElementById('loadBtn');
            const manualBtn = document.getElementById('manualBtn');
            const fileInput = document.getElementById('fileInput');

            mermaid.initialize({
                theme: 'base',
                themeVariables: {
                    'background': '#ffffff',
                    'primaryColor': '#f9f9f9',
                    'primaryBorderColor': '#333',
                    'primaryTextColor': '#1e1e2f',
                    'lineColor': '#5d6d7e',
                },
                flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis', padding: 20 },
                securityLevel: 'loose',
                startOnLoad: false
            });

            function showStatus(msg, isError = false) {
                statusDiv.textContent = msg;
                statusDiv.style.backgroundColor = isError ? '#fadbd8' : '#fff8e5';
                statusDiv.style.borderLeftColor = isError ? '#e74c3c' : '#f1c40f';
            }

            // –ü–∞—Ä—Å–∏–Ω–≥ Excel
            function parseExcel(arrayBuffer) {
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('person')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    if (rows.length < 2) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç–µ person');
                    const dataRows = rows.slice(1).filter(row => row[1] && row[1].toString().trim() !== '');
                    const peopleList = dataRows.map(row => ({
                        idA: row[0] ? row[0].toString().trim() : '',
                        label: row[1] ? row[1].toString().trim() : '',
                        sex: row[2] ? row[2].toString().trim() : '',
                        hasFather: row[4] ? row[4].toString().trim() : '',
                        hasMother: row[5] ? row[5].toString().trim() : '',
                        birth: row[6] ? row[6].toString().trim() : '',
                        death: row[7] ? row[7].toString().trim() : ''
                    })).filter(p => p.idA && p.label);
                    if (peopleList.length === 0) throw new Error('–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å idA –∏ label');
                    return peopleList;
                } catch (e) {
                    showStatus('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel: ' + e.message, true);
                    throw e;
                }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ Mermaid —Å \n –∏ –∫–ª–∞—Å—Å–∞–º–∏
            function generateMermaidCode(people) {
                const nodes = [];
                const edges = [];
                const coupleSet = new Set();

                const classDefs = [
                    'classDef male fill:#a3c4f3,stroke:#2c3e50,stroke-width:2px;',
                    'classDef female fill:#fbb9c0,stroke:#a6344b,stroke-width:2px;',
                    'classDef unknown fill:#d5d8dc,stroke:#2c3e50,stroke-width:2px;'
                ];

                people.forEach(p => {
                    const birthYear = p.birth || '?';
                    const deathYear = p.death || '?';
                    // –í–∞–∂–Ω–æ: –¥–≤–∞ —Å–ª–µ—à–∞ –≤ —Å—Ç—Ä–æ–∫–µ JS, —á—Ç–æ–±—ã –≤ –∏—Ç–æ–≥–µ –±—ã–ª –æ–¥–∏–Ω \n
                    const label = `${p.label}\\n(${birthYear}‚Äì${deathYear})`;
                    nodes.push(`${p.idA}["${label}"]`);
                });

                people.forEach(p => {
                    if (p.hasFather) edges.push(`${p.hasFather} --> ${p.idA}`);
                    if (p.hasMother) edges.push(`${p.hasMother} --> ${p.idA}`);
                    if (p.hasFather && p.hasMother) {
                        const coupleKey = p.hasFather < p.hasMother ? `${p.hasFather}|${p.hasMother}` : `${p.hasMother}|${p.hasFather}`;
                        coupleSet.add(coupleKey);
                    }
                });

                coupleSet.forEach(couple => {
                    const [a, b] = couple.split('|');
                    edges.push(`${a} --- ${b}`);
                });

                const classAssignments = people.map(p => {
                    let cls = 'unknown';
                    if (p.sex === '–ú' || p.sex === 'M') cls = 'male';
                    else if (p.sex === '–ñ' || p.sex === 'F') cls = 'female';
                    return `class ${p.idA} ${cls};`;
                });

                return `graph TB\n  ${nodes.join('\n  ')}\n  ${edges.join('\n  ')}\n  ${classDefs.join('\n  ')}\n  ${classAssignments.join('\n  ')}`;
            }

            // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –¥–ª—è mermaid.live (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)
            function compressToBase64(str) {
                try {
                    const compressed = pako.deflate(str, { level: 9 });
                    let binaryString = '';
                    compressed.forEach(byte => binaryString += String.fromCharCode(byte));
                    return btoa(binaryString);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–∂–∞—Ç–∏—è:', error);
                    return '';
                }
            }

            // –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ)
            async function customizeNodes() {
                const svg = document.querySelector('#mermaidContainer svg');
                if (!svg) return;

                for (const person of people) {
                    const expectedLabel = `${person.label} (${person.birth || '?'}‚Äì${person.death || '?'})`;
                    const groups = svg.querySelectorAll('g');
                    let targetGroup = null;
                    for (let g of groups) {
                        const textElem = g.querySelector('text');
                        if (textElem && textElem.textContent.replace(/\s+/g, ' ').includes(expectedLabel.replace(/\s+/g, ' '))) {
                            targetGroup = g;
                            break;
                        }
                    }
                    if (!targetGroup) continue;

                    const rect = targetGroup.querySelector('rect');
                    if (!rect) continue;

                    const x = parseFloat(rect.getAttribute('x'));
                    const y = parseFloat(rect.getAttribute('y'));
                    const width = parseFloat(rect.getAttribute('width'));
                    const height = parseFloat(rect.getAttribute('height'));

                    targetGroup.querySelectorAll('rect, text').forEach(el => el.remove());

                    const fo = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                    fo.setAttribute('x', x);
                    fo.setAttribute('y', y);
                    fo.setAttribute('width', width);
                    fo.setAttribute('height', height);

                    const div = document.createElement('div');
                    div.style.cssText = `
                        display: flex;
                        align-items: center;
                        height: 100%;
                        width: 100%;
                        background-color: ${person.sex === '–ú' ? '#a3c4f3' : (person.sex === '–ñ' ? '#fbb9c0' : '#d5d8dc')};
                        border: 2px solid ${person.sex === '–ú' ? '#2c3e50' : '#a6344b'};
                        border-radius: 8px;
                        overflow: hidden;
                        box-sizing: border-box;
                        padding: 4px;
                    `;

                    // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ‚Äî –∑–∞–≥–ª—É—à–∫–∞
                    const img = document.createElement('img');
                    img.style.cssText = 'width:45px; height:45px; object-fit:cover; border-radius:6px; margin-right:8px; border:1px solid #fff; flex-shrink:0;';
                    
                    // –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ—Ç–æ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                    const setImage = (src) => {
                        img.src = src + '?t=' + Date.now();
                        img.onerror = () => {
                            if (src.includes('default')) return; // –∏–∑–±–µ–≥–∞–µ–º —Ü–∏–∫–ª–∞
                            const defaultImg = person.sex === '–ú' ? 'pic/defaultm.png' : 'pic/defaultf.png';
                            setImage(defaultImg);
                        };
                    };
                    setImage(`pic/${person.idA}.png`);

                    const textDiv = document.createElement('div');
                    textDiv.style.cssText = 'display:flex; flex-direction:column; justify-content:center; flex:1; font-size:12px; line-height:1.4; color:#1e1e2f; font-weight:500;';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = person.label;
                    nameSpan.style.fontWeight = 'bold';
                    
                    const yearsSpan = document.createElement('span');
                    yearsSpan.textContent = `${person.birth || '?'} ‚Äî ${person.death || '?'}`;
                    yearsSpan.style.fontSize = '11px';
                    yearsSpan.style.opacity = '0.8';

                    textDiv.appendChild(nameSpan);
                    textDiv.appendChild(yearsSpan);
                    div.appendChild(img);
                    div.appendChild(textDiv);
                    fo.appendChild(div);
                    targetGroup.appendChild(fo);
                }
            }

            // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞
            async function buildTree(peopleArray) {
                if (!peopleArray.length) return;
                people = peopleArray;
                rawMermaidCode = generateMermaidCode(people);
                mermaidLiveBtn.disabled = false;

                container.innerHTML = '';
                try {
                    const { svg } = await mermaid.render('mermaidChart', rawMermaidCode);
                    container.innerHTML = svg;
                    // –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É, –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ
                    setTimeout(() => customizeNodes(), 100);
                    showStatus('‚úÖ –î–µ—Ä–µ–≤–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ');
                } catch (err) {
                    showStatus('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞: ' + err.message, true);
                }
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞
            async function loadFromUrl(url) {
                try {
                    showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = parseExcel(await response.arrayBuffer());
                    await buildTree(data);
                } catch (e) {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, true);
                }
            }

            function loadFromFile(file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = parseExcel(e.target.result);
                        await buildTree(data);
                    } catch (err) {
                        showStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ' + err.message, true);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            // –°–æ–±—ã—Ç–∏—è
            loadBtn.addEventListener('click', () => loadFromUrl('tree.xlsx'));
            manualBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) loadFromFile(e.target.files[0]);
                fileInput.value = '';
            });

            mermaidLiveBtn.addEventListener('click', () => {
                if (!rawMermaidCode) return;
                const compressed = compressToBase64(rawMermaidCode);
                window.open(`https://mermaid.live/view#pako:${compressed}`, '_blank');
            });

            // –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
            loadFromUrl('tree.xlsx');
        })();
    </script>
</body>
</html>