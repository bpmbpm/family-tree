<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ –Ω–∞ excel + Graphviz (—Å —Ñ–æ—Ç–æ)</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ @viz-js/viz (—Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è) -->
    <script src="https://unpkg.com/@viz-js/viz@3.4.0/lib/viz-standalone.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Pako –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è —Å—Å—ã–ª–∫–∏, –Ω–æ –æ—Å—Ç–∞–≤–∏–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ç–∞–∫–∏–µ –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .toolbar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        button { padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #1e2b37; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        #fileInput { display: none; }
        .status { padding: 10px 15px; background: #fff8e5; border-left: 5px solid #f1c40f; margin-bottom: 20px; }
        .graphviz-container { 
            background: white; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            overflow-x: auto; 
            min-height: 500px; 
            text-align: center;
        }
        .graphviz-container svg { max-width: 100%; height: auto; margin: 0 auto; display: block; }
        .info-panels { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .panel { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .panel-header { background: #e9ecef; padding: 10px 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .panel-header:hover { background: #dee2e6; }
        .panel-header .toggle-icon { font-size: 1.2em; }
        .panel-content { padding: 15px; border-top: 1px solid #ddd; display: none; }
        .panel-content.visible { display: block; }
        .placeholder-images { display: flex; gap: 30px; flex-wrap: wrap; align-items: center; }
        .placeholder-item { text-align: center; }
        .placeholder-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ccc; background: #f8f9fa; }
        .placeholder-item .path { font-family: monospace; font-size: 12px; margin-top: 5px; color: #495057; }
        .dot-code { background: #f8f9fa; padding: 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; max-height: 300px; overflow: auto; border: 1px solid #ced4da; }
        .link-box { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .link-box input { flex: 1; min-width: 300px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace; font-size: 13px; background: #f8f9fa; }
        .link-box button { padding: 6px 12px; font-size: 13px; }
        footer { margin-top: 25px; text-align: center; color: #5d6d7e; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå≥ –°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ –Ω–∞ excel + Graphviz (—Å —Ñ–æ—Ç–æ)</h1>
        <div class="toolbar">
            <button id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å tree.xlsx</button>
            <button id="manualBtn">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            <button id="graphvizOnlineBtn" disabled>üîó –ü–æ–∫–∞–∑–∞—Ç—å –≤ –æ–∫–Ω–µ GraphvizOnline</button>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
        </div>
        <div id="status" class="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...</div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ -->
        <div class="info-panels">
            <div class="panel" id="panel-link">
                <div class="panel-header" onclick="togglePanel('panel-link-content')">
                    <span>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ GraphvizOnline</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="panel-content" id="panel-link-content">
                    <div class="link-box">
                        <input type="text" id="graphvizLinkInput" readonly value="(—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)" />
                        <button onclick="copyLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
            
            <div class="panel" id="panel-placeholders">
                <div class="panel-header" onclick="togglePanel('panel-placeholders-content')">
                    <span>üñºÔ∏è –ó–∞–≥–ª—É—à–∫–∏ —Ñ–æ—Ç–æ (defaultm.png / defaultf.png)</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="panel-content" id="panel-placeholders-content">
                    <div class="placeholder-images">
                        <div class="placeholder-item">
                            <img src="pic/defaultm.png" alt="defaultm" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\' viewBox=\'0 0 60 60\'%3E%3Crect width=\'60\' height=\'60\' fill=\'%23ddd\'/%3E%3Ctext x=\'30\' y=\'35\' font-size=\'10\' text-anchor=\'middle\' fill=\'%23333\'%3E–Ω–µ—Ç m%3C/text%3E%3C/svg%3E';">
                            <div class="path">pic/defaultm.png</div>
                        </div>
                        <div class="placeholder-item">
                            <img src="pic/defaultf.png" alt="defaultf" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'60\' height=\'60\' viewBox=\'0 0 60 60\'%3E%3Crect width=\'60\' height=\'60\' fill=\'%23ddd\'/%3E%3Ctext x=\'30\' y=\'35\' font-size=\'10\' text-anchor=\'middle\' fill=\'%23333\'%3E–Ω–µ—Ç f%3C/text%3E%3C/svg%3E';">
                            <div class="path">pic/defaultf.png</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel" id="panel-code">
                <div class="panel-header" onclick="togglePanel('panel-code-content')">
                    <span>üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ DOT (–Ω–µ—Å–∂–∞—Ç—ã–π)</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="panel-content" id="panel-code-content">
                    <pre id="dotCodePre" class="dot-code">(–∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)</pre>
                </div>
            </div>
        </div>
        
        <div id="graphvizContainer" class="graphviz-container">–î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –∑–¥–µ—Å—å...</div>
        
        <footer>–§–æ—Ç–æ –∏–∑ –ø–∞–ø–∫–∏ <code>pic/</code> (idA.png). –î–ª—è –º—É–∂—á–∏–Ω —Ä–∞–º–∫–∞ —Å–∏–Ω—è—è, –¥–ª—è –∂–µ–Ω—â–∏–Ω ‚Äî —Ä–æ–∑–æ–≤–∞—è. –ì–æ–¥—ã –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.</footer>
    </div>

    <script>
        (function() {
            let people = [];
            let dotCode = '';
            let graphvizLink = '';
            
            const graphvizOnlineBtn = document.getElementById('graphvizOnlineBtn');
            const statusDiv = document.getElementById('status');
            const container = document.getElementById('graphvizContainer');
            const loadBtn = document.getElementById('loadBtn');
            const manualBtn = document.getElementById('manualBtn');
            const fileInput = document.getElementById('fileInput');
            const graphvizLinkInput = document.getElementById('graphvizLinkInput');
            const dotCodePre = document.getElementById('dotCodePre');

            window.togglePanel = function(contentId) {
                const content = document.getElementById(contentId);
                const icon = content.previousElementSibling.querySelector('.toggle-icon');
                content.classList.toggle('visible');
                icon.textContent = content.classList.contains('visible') ? '‚ñº' : '‚ñ∂';
            };

            window.copyLink = function() {
                graphvizLinkInput.select();
                document.execCommand('copy');
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            };

            function showStatus(msg, isError = false) {
                statusDiv.textContent = msg;
                statusDiv.style.backgroundColor = isError ? '#fadbd8' : '#fff8e5';
                statusDiv.style.borderLeftColor = isError ? '#e74c3c' : '#f1c40f';
            }

            function parseExcel(arrayBuffer) {
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('person')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    if (rows.length < 2) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç–µ person');
                    const dataRows = rows.slice(1).filter(row => row[1] && row[1].toString().trim() !== '');
                    const peopleList = dataRows.map(row => ({
                        idA: row[0] ? row[0].toString().trim() : '',
                        label: row[1] ? row[1].toString().trim() : '',
                        sex: row[2] ? row[2].toString().trim() : '',
                        hasFather: row[4] ? row[4].toString().trim() : '',
                        hasMother: row[5] ? row[5].toString().trim() : '',
                        birth: row[6] ? row[6].toString().trim() : '',
                        death: row[7] ? row[7].toString().trim() : ''
                    })).filter(p => p.idA && p.label);
                    if (peopleList.length === 0) throw new Error('–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å idA –∏ label');
                    return peopleList;
                } catch (e) {
                    showStatus('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel: ' + e.message, true);
                    throw e;
                }
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è DOT-–∫–æ–¥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º idA –∫–∞–∫ –∏–º–µ–Ω–∏ —É–∑–ª–∞ –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ç–æ
            function generateDotCode(people) {
                const nodes = [];
                const edges = [];
                const coupleSet = new Set();

                const maleColor = "#a3c4f3";
                const femaleColor = "#fbb9c0";
                const unknownColor = "#d5d8dc";

                people.forEach(p => {
                    const birthYear = p.birth || '?';
                    const deathYear = p.death || '?';
                    
                    let fillcolor = unknownColor;
                    if (p.sex === '–ú' || p.sex === 'M') fillcolor = maleColor;
                    else if (p.sex === '–ñ' || p.sex === 'F') fillcolor = femaleColor;

                    // –ò–º—è —É–∑–ª–∞ ‚Äî –∏—Å—Ö–æ–¥–Ω—ã–π idA (—É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è)
                    const nodeId = p.idA;  // –Ω–∏–∫–∞–∫–∏—Ö –∑–∞–º–µ–Ω!

                    // –ú–µ—Ç–∫–∞ —É–∑–ª–∞: –∏–º—è –∏ –≥–æ–¥—ã, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ \n
                    const label = `${p.label}\\n(${birthYear}‚Äì${deathYear})`;

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç—ã image –∏ imagescale
                    // shape=box, style="filled,rounded" –¥–ª—è –∑–∞–ª–∏–≤–∫–∏ –∏ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è
                    // image —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ pic
                    // imagescale=true –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —É–∑–ª–∞
                    nodes.push(`  ${nodeId} [shape=box, style="filled,rounded", fillcolor="${fillcolor}", color="#2c3e50", fontname="Arial", fontsize=12, label="${label}", image="pic/${p.idA}.png", imagescale=true];`);
                });

                // –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤—è–∑–∏
                people.forEach(p => {
                    const childId = p.idA;
                    if (p.hasFather) {
                        const fatherId = p.hasFather;
                        edges.push(`  ${fatherId} -> ${childId};`);
                    }
                    if (p.hasMother) {
                        const motherId = p.hasMother;
                        edges.push(`  ${motherId} -> ${childId};`);
                    }
                    if (p.hasFather && p.hasMother) {
                        const coupleKey = p.hasFather < p.hasMother ? `${p.hasFather}|${p.hasMother}` : `${p.hasMother}|${p.hasFather}`;
                        coupleSet.add(coupleKey);
                    }
                });

                // –°—É–ø—Ä—É–∂–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ (–Ω–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ)
                coupleSet.forEach(couple => {
                    const [a, b] = couple.split('|');
                    edges.push(`  ${a} -> ${b} [dir=none, color="#5d6d7e"];`);
                });

                return `digraph G {\n  rankdir=TB;\n  node [fontname="Arial", fontsize=12];\n  edge [color="#5d6d7e"];\n\n${nodes.join('\n')}\n\n${edges.join('\n')}\n}`;
            }

            // –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ @viz-js/viz
            async function renderDot(dotCode) {
                try {
                    const viz = await Viz.instance();
                    const svg = await viz.renderString(dotCode, { format: 'svg' });
                    container.innerHTML = svg;
                } catch (error) {
                    container.innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞: ${error.message}</p>`;
                    console.error(error);
                }
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π
            function updateInfoPanels() {
                if (dotCode) {
                    dotCodePre.textContent = dotCode;
                    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è GraphvizOnline (–∫–æ–¥–∏—Ä—É–µ–º DOT –≤ URI)
                    const encoded = encodeURIComponent(dotCode);
                    graphvizLink = `https://dreampuf.github.io/GraphvizOnline/?engine=dot#${encoded}`;
                    graphvizLinkInput.value = graphvizLink;
                } else {
                    dotCodePre.textContent = '(–∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)';
                    graphvizLinkInput.value = '(—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)';
                }
            }

            async function buildTree(peopleArray) {
                if (!peopleArray.length) return;
                people = peopleArray;
                dotCode = generateDotCode(people);
                graphvizOnlineBtn.disabled = false;
                updateInfoPanels();
                await renderDot(dotCode);
                showStatus('‚úÖ –î–µ—Ä–µ–≤–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ (—Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ç–æ)');
            }

            async function loadFromUrl(url) {
                try {
                    showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = parseExcel(await response.arrayBuffer());
                    await buildTree(data);
                } catch (e) {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, true);
                }
            }

            function loadFromFile(file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = parseExcel(e.target.result);
                        await buildTree(data);
                    } catch (err) {
                        showStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ' + err.message, true);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            loadBtn.addEventListener('click', () => loadFromUrl('tree.xlsx'));
            manualBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) loadFromFile(e.target.files[0]);
                fileInput.value = '';
            });

            graphvizOnlineBtn.addEventListener('click', () => {
                if (graphvizLink) window.open(graphvizLink, '_blank');
            });

            loadFromUrl('tree.xlsx');
        })();
    </script>
</body>
</html>
