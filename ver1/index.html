<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ –Ω–∞ excel + Graphviz (—Å —Ñ–æ—Ç–æ)</title>
    <script src="https://unpkg.com/@viz-js/viz@3.4.0/lib/viz-standalone.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        .toolbar { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        button { padding: 8px 16px; background: #2c3e50; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #1e2b37; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        #fileInput { display: none; }
        .status { padding: 10px 15px; background: #fff8e5; border-left: 5px solid #f1c40f; margin-bottom: 20px; }
        .info-panels { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .panel { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .panel-header { background: #e9ecef; padding: 10px 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .panel-header:hover { background: #dee2e6; }
        .panel-header .toggle-icon { font-size: 1.2em; }
        .panel-content { padding: 15px; border-top: 1px solid #ddd; display: none; }
        .panel-content.visible { display: block; }
        .photos-grid { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-start; }
        .photo-item { text-align: center; }
        .photo-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ccc; background: #f8f9fa; display: block; }
        .photo-item .path { font-family: monospace; font-size: 11px; margin-top: 4px; color: #495057; max-width: 80px; word-break: break-all; }
        .dot-code { background: #f8f9fa; padding: 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; max-height: 300px; overflow: auto; border: 1px solid #ced4da; }
        .link-box { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .link-box input { flex: 1; min-width: 300px; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace; font-size: 13px; background: #f8f9fa; }
        .link-box button { padding: 6px 12px; font-size: 13px; }
        footer { margin-top: 25px; text-align: center; color: #5d6d7e; font-size: 0.9rem; }

        /* Diagram panel */
        .diagram-panel { background: white; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px; }
        .diagram-panel-header { background: #e9ecef; padding: 10px 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .diagram-panel-title { font-size: 1.05em; }

        /* Zoom controls */
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        .zoom-controls button {
            padding: 5px 12px;
            font-size: 14px;
            background: #607D8B;
        }
        .zoom-controls button:hover { background: #455A64; }
        .zoom-controls span {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #333;
            font-size: 13px;
        }

        /* Zoom container */
        .zoom-container {
            position: relative;
            overflow: auto;
            min-height: 500px;
            max-height: 80vh;
            background: white;
            padding: 10px;
        }
        .zoom-content {
            transform-origin: top left;
            transition: transform 0.15s ease;
            display: inline-block;
        }
        .zoom-content svg {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå≥ –°–µ–º–µ–π–Ω–æ–µ –¥—Ä–µ–≤–æ –Ω–∞ excel + Graphviz (—Å —Ñ–æ—Ç–æ)</h1>
        <div class="toolbar">
            <button id="loadBtn">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å tree.xlsx</button>
            <button id="manualBtn">üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            <button id="graphvizOnlineBtn" disabled>üîó –ü–æ–∫–∞–∑–∞—Ç—å –≤ –æ–∫–Ω–µ GraphvizOnline</button>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
        </div>
        <div id="status" class="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...</div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ -->
        <div class="info-panels">
            <div class="panel" id="panel-link">
                <div class="panel-header" onclick="togglePanel('panel-link-content')">
                    <span>üîó –°—Å—ã–ª–∫–∞ –Ω–∞ GraphvizOnline</span>
                    <span class="toggle-icon">‚ñ∂</span>
                </div>
                <div class="panel-content" id="panel-link-content">
                    <div class="link-box">
                        <input type="text" id="graphvizLinkInput" readonly value="(—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)" />
                        <button onclick="copyLink()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-placeholders">
                <div class="panel-header" onclick="togglePanel('panel-placeholders-content')">
                    <span>üñºÔ∏è –§–æ—Ç–æ –ø–µ—Ä—Å–æ–Ω</span>
                    <span class="toggle-icon">‚ñ∂</span>
                </div>
                <div class="panel-content" id="panel-placeholders-content">
                    <div class="photos-grid" id="photosGrid">
                        <em style="color:#888">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ç–æ</em>
                    </div>
                </div>
            </div>

            <div class="panel" id="panel-code">
                <div class="panel-header" onclick="togglePanel('panel-code-content')">
                    <span>üìÑ –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ DOT (–Ω–µ—Å–∂–∞—Ç—ã–π)</span>
                    <span class="toggle-icon">‚ñ∂</span>
                </div>
                <div class="panel-content" id="panel-code-content">
                    <pre id="dotCodePre" class="dot-code">(–∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)</pre>
                </div>
            </div>
        </div>

        <!-- Diagram panel with zoom controls -->
        <div class="diagram-panel">
            <div class="diagram-panel-header">
                <span class="diagram-panel-title">üìä –î–∏–∞–≥—Ä–∞–º–º–∞</span>
            </div>
            <div class="zoom-controls" id="zoom-controls">
                <button onclick="zoomIn()" title="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                <span id="zoom-level">100%</span>
                <button onclick="zoomOut()" title="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                <button onclick="zoomReset()" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">–°–±—Ä–æ—Å</button>
                <button onclick="zoomFit()" title="–í–ø–∏—Å–∞—Ç—å –≤ –æ–∫–Ω–æ">–í–ø–∏—Å–∞—Ç—å</button>
            </div>
            <div class="zoom-container" id="zoomContainer">
                <div class="zoom-content" id="zoomContent">
                    <div id="graphvizContainer">–î–µ—Ä–µ–≤–æ –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –∑–¥–µ—Å—å...</div>
                </div>
            </div>
        </div>

        <footer>–§–æ—Ç–æ –∏–∑ –ø–∞–ø–∫–∏ <code>pic/</code> (idA.png). –î–ª—è –º—É–∂—á–∏–Ω —Ä–∞–º–∫–∞ —Å–∏–Ω—è—è, –¥–ª—è –∂–µ–Ω—â–∏–Ω ‚Äî —Ä–æ–∑–æ–≤–∞—è. –ì–æ–¥—ã –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.</footer>
    </div>

    <script>
        (function() {
            let people = [];
            let dotCode = '';
            let graphvizLink = '';
            let currentScale = 1.0;
            // Cache: filename -> base64 data URI (or null if not found)
            const photoCache = {};

            const graphvizOnlineBtn = document.getElementById('graphvizOnlineBtn');
            const statusDiv = document.getElementById('status');
            const graphvizContainer = document.getElementById('graphvizContainer');
            const zoomContent = document.getElementById('zoomContent');
            const zoomContainer = document.getElementById('zoomContainer');
            const zoomLevelSpan = document.getElementById('zoom-level');
            const loadBtn = document.getElementById('loadBtn');
            const manualBtn = document.getElementById('manualBtn');
            const fileInput = document.getElementById('fileInput');
            const graphvizLinkInput = document.getElementById('graphvizLinkInput');
            const dotCodePre = document.getElementById('dotCodePre');

            // --- Panel toggling ---
            window.togglePanel = function(contentId) {
                const content = document.getElementById(contentId);
                const icon = content.previousElementSibling.querySelector('.toggle-icon');
                content.classList.toggle('visible');
                icon.textContent = content.classList.contains('visible') ? '‚ñº' : '‚ñ∂';
            };

            window.copyLink = function() {
                graphvizLinkInput.select();
                document.execCommand('copy');
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
            };

            // --- Zoom controls ---
            function applyZoom() {
                zoomContent.style.transform = `scale(${currentScale})`;
                zoomLevelSpan.textContent = Math.round(currentScale * 100) + '%';
            }

            window.zoomIn = function() {
                if (currentScale < 5.0) { currentScale = Math.min(5.0, currentScale + 0.1); applyZoom(); }
            };
            window.zoomOut = function() {
                if (currentScale > 0.1) { currentScale = Math.max(0.1, currentScale - 0.1); applyZoom(); }
            };
            window.zoomReset = function() {
                currentScale = 1.0;
                applyZoom();
            };
            window.zoomFit = function() {
                const svg = graphvizContainer.querySelector('svg');
                if (!svg) return;
                const containerW = zoomContainer.clientWidth - 20;
                const containerH = zoomContainer.clientHeight - 20;
                const svgW = svg.getBoundingClientRect().width / currentScale;
                const svgH = svg.getBoundingClientRect().height / currentScale;
                if (svgW <= 0 || svgH <= 0) return;
                const scaleX = containerW / svgW;
                const scaleY = containerH / svgH;
                currentScale = Math.min(scaleX, scaleY, 1.0);
                applyZoom();
            };

            // Mouse wheel zoom
            zoomContainer.addEventListener('wheel', function(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                currentScale = Math.min(5.0, Math.max(0.1, currentScale + delta));
                applyZoom();
            }, { passive: false });

            // --- Status ---
            function showStatus(msg, isError = false) {
                statusDiv.textContent = msg;
                statusDiv.style.backgroundColor = isError ? '#fadbd8' : '#fff8e5';
                statusDiv.style.borderLeftColor = isError ? '#e74c3c' : '#f1c40f';
            }

            // --- Load photo as base64 ---
            async function loadPhotoAsBase64(filename) {
                if (photoCache[filename] !== undefined) return photoCache[filename];
                try {
                    const response = await fetch('pic/' + filename);
                    if (!response.ok) {
                        photoCache[filename] = null;
                        return null;
                    }
                    const blob = await response.blob();
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            photoCache[filename] = reader.result;
                            resolve(reader.result);
                        };
                        reader.onerror = () => {
                            photoCache[filename] = null;
                            resolve(null);
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch {
                    photoCache[filename] = null;
                    return null;
                }
            }

            // --- Preload all photos for people ---
            async function preloadPhotos(peopleList) {
                const filenames = new Set();
                filenames.add('dafaultm.png');
                filenames.add('dafaultf.png');
                peopleList.forEach(p => {
                    if (p.idA) filenames.add(p.idA + '.png');
                });
                await Promise.all(Array.from(filenames).map(fn => loadPhotoAsBase64(fn)));
            }

            // --- Determine photo data URI for a person ---
            function getPhotoDataUri(person) {
                const personalPhoto = photoCache[person.idA + '.png'];
                if (personalPhoto) return personalPhoto;
                if (person.sex === '–ñ' || person.sex === 'F') {
                    return photoCache['dafaultf.png'] || null;
                }
                return photoCache['dafaultm.png'] || null;
            }

            // --- Parse Excel ---
            function parseExcel(arrayBuffer) {
                try {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('person')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    if (rows.length < 2) throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç–µ person');
                    const dataRows = rows.slice(1).filter(row => row[1] && row[1].toString().trim() !== '');
                    const peopleList = dataRows.map(row => ({
                        idA: row[0] ? row[0].toString().trim() : '',
                        label: row[1] ? row[1].toString().trim() : '',
                        sex: row[2] ? row[2].toString().trim() : '',
                        hasFather: row[4] ? row[4].toString().trim() : '',
                        hasMother: row[5] ? row[5].toString().trim() : '',
                        birth: row[6] ? row[6].toString().trim() : '',
                        death: row[7] ? row[7].toString().trim() : ''
                    })).filter(p => p.idA && p.label);
                    if (peopleList.length === 0) throw new Error('–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π —Å idA –∏ label');
                    return peopleList;
                } catch (e) {
                    showStatus('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ Excel: ' + e.message, true);
                    throw e;
                }
            }

            // --- Generate DOT code (without image attribute - photos added in post-processing) ---
            function generateDotCode(peopleList) {
                const nodes = [];
                const edges = [];
                const coupleSet = new Set();

                const maleColor = "#a3c4f3";
                const femaleColor = "#fbb9c0";
                const unknownColor = "#d5d8dc";

                peopleList.forEach(p => {
                    const birthYear = p.birth || '?';
                    const deathYear = p.death || '?';

                    let fillcolor = unknownColor;
                    if (p.sex === '–ú' || p.sex === 'M') fillcolor = maleColor;
                    else if (p.sex === '–ñ' || p.sex === 'F') fillcolor = femaleColor;

                    const nodeId = p.idA;
                    // Use fixed size with enough room: photo (~60pt) on left + text on right
                    // width=2.2in, height=0.9in gives enough space for photo + two lines of text
                    const label = `${p.label}\\n(${birthYear}‚Äì${deathYear})`;

                    // margin="left+right, top+bottom" in inches.
                    // We add a large left margin so Graphviz places text to the right,
                    // leaving room for the photo that will be injected on the left side.
                    // Photo ‚âà height - 8px padding. At 72dpi, height=0.9in=64.8pt ‚Üí photo‚âà57pt‚âà0.79in.
                    // We set left margin = 0.82in so text stays right of photo area.
                    nodes.push(`  ${nodeId} [shape=box, style="filled,rounded", fillcolor="${fillcolor}", color="#2c3e50", fontname="Arial", fontsize=11, label="${label}", margin="0.82,0.1"];`);
                });

                // Parent relationships
                peopleList.forEach(p => {
                    const childId = p.idA;
                    if (p.hasFather) edges.push(`  ${p.hasFather} -> ${childId};`);
                    if (p.hasMother) edges.push(`  ${p.hasMother} -> ${childId};`);
                    if (p.hasFather && p.hasMother) {
                        const key = p.hasFather < p.hasMother ? `${p.hasFather}|${p.hasMother}` : `${p.hasMother}|${p.hasFather}`;
                        coupleSet.add(key);
                    }
                });

                // Couple links
                coupleSet.forEach(couple => {
                    const [a, b] = couple.split('|');
                    edges.push(`  ${a} -> ${b} [dir=none, color="#5d6d7e"];`);
                });

                return `digraph G {\n  rankdir=TB;\n  node [fontname="Arial", fontsize=11];\n  edge [color="#5d6d7e"];\n\n${nodes.join('\n')}\n\n${edges.join('\n')}\n}`;
            }

            // --- Inject photos into rendered SVG ---
            // After Graphviz renders the SVG, we find each node group,
            // shift the text to the right, and insert a photo on the left.
            function injectPhotosIntoSVG(svgElement, peopleList) {
                const svgNS = 'http://www.w3.org/2000/svg';
                const xlinkNS = 'http://www.w3.org/1999/xlink';

                // Ensure <defs> exists for clip paths
                let defs = svgElement.querySelector('defs');
                if (!defs) {
                    defs = document.createElementNS(svgNS, 'defs');
                    svgElement.insertBefore(defs, svgElement.firstChild);
                }

                // Graphviz renders each node as a <g class="node">
                const nodeGroups = svgElement.querySelectorAll('g.node');

                nodeGroups.forEach(g => {
                    const titleEl = g.querySelector('title');
                    if (!titleEl) return;
                    const nodeId = titleEl.textContent.trim();
                    const person = peopleList.find(p => p.idA === nodeId);
                    if (!person) return;

                    const photoData = getPhotoDataUri(person);
                    if (!photoData) return;

                    // Find the shape element for bounding box
                    const shape = g.querySelector('polygon, ellipse, path, rect');
                    if (!shape) return;

                    const bbox = shape.getBBox();
                    if (bbox.width <= 0 || bbox.height <= 0) return;

                    // Photo: square occupying left portion of the node
                    // Use a fixed photo size based on node height, with small padding
                    const padding = 5;
                    const photoSize = bbox.height - padding * 2;
                    const photoX = bbox.x + padding;
                    const photoY = bbox.y + padding;
                    // Note: text positioning is handled via the DOT margin attribute,
                    // so we don't need to shift text elements here.

                    // Create clipPath for rounded photo
                    const safeId = nodeId.replace(/[^a-zA-Z0-9]/g, '_');
                    const clipId = 'clip-photo-' + safeId;

                    const clipPath = document.createElementNS(svgNS, 'clipPath');
                    clipPath.setAttribute('id', clipId);
                    const clipRect = document.createElementNS(svgNS, 'rect');
                    clipRect.setAttribute('x', photoX);
                    clipRect.setAttribute('y', photoY);
                    clipRect.setAttribute('width', photoSize);
                    clipRect.setAttribute('height', photoSize);
                    clipRect.setAttribute('rx', '5');
                    clipRect.setAttribute('ry', '5');
                    clipPath.appendChild(clipRect);
                    defs.appendChild(clipPath);

                    // Create image element (after shape, before text)
                    const imgEl = document.createElementNS(svgNS, 'image');
                    imgEl.setAttribute('x', photoX);
                    imgEl.setAttribute('y', photoY);
                    imgEl.setAttribute('width', photoSize);
                    imgEl.setAttribute('height', photoSize);
                    imgEl.setAttribute('href', photoData);
                    imgEl.setAttributeNS(xlinkNS, 'xlink:href', photoData);
                    imgEl.setAttribute('preserveAspectRatio', 'xMidYMid slice');
                    imgEl.setAttribute('clip-path', `url(#${clipId})`);

                    // Insert photo after the shape
                    shape.parentNode.insertBefore(imgEl, shape.nextSibling);

                    // Add thin border around photo
                    const borderRect = document.createElementNS(svgNS, 'rect');
                    borderRect.setAttribute('x', photoX);
                    borderRect.setAttribute('y', photoY);
                    borderRect.setAttribute('width', photoSize);
                    borderRect.setAttribute('height', photoSize);
                    borderRect.setAttribute('rx', '5');
                    borderRect.setAttribute('ry', '5');
                    borderRect.setAttribute('fill', 'none');
                    borderRect.setAttribute('stroke', '#555');
                    borderRect.setAttribute('stroke-width', '1');
                    imgEl.parentNode.insertBefore(borderRect, imgEl.nextSibling);
                });
            }

            // --- Render DOT code ---
            async function renderDot(dotStr) {
                try {
                    const viz = await Viz.instance();
                    const svgStr = await viz.renderString(dotStr, { format: 'svg' });
                    graphvizContainer.innerHTML = svgStr;

                    // Post-process: inject photos
                    const svgEl = graphvizContainer.querySelector('svg');
                    if (svgEl && people.length > 0) {
                        injectPhotosIntoSVG(svgEl, people);
                    }
                } catch (error) {
                    graphvizContainer.innerHTML = `<p style="color:red">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞: ${error.message}</p>`;
                    console.error(error);
                }
            }

            // --- Update photos panel ---
            function updatePhotosPanel() {
                const grid = document.getElementById('photosGrid');
                grid.innerHTML = '';

                // Always show defaults first
                const allFiles = ['dafaultm.png', 'dafaultf.png'];
                // Add person photos that we tried to load
                people.forEach(p => {
                    const fn = p.idA + '.png';
                    if (!allFiles.includes(fn)) allFiles.push(fn);
                });

                allFiles.forEach(filename => {
                    const dataUri = photoCache[filename];
                    const div = document.createElement('div');
                    div.className = 'photo-item';

                    const img = document.createElement('img');
                    if (dataUri) {
                        img.src = dataUri;
                    } else {
                        // Show a placeholder SVG for missing photos
                        img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect width='60' height='60' fill='%23eee'/%3E%3Ctext x='30' y='35' font-size='9' text-anchor='middle' fill='%23999'%3E–Ω–µ—Ç%3C/text%3E%3C/svg%3E`;
                        img.style.opacity = '0.4';
                    }
                    img.alt = filename;
                    img.title = filename + (dataUri ? '' : ' (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)');

                    const label = document.createElement('div');
                    label.className = 'path';
                    // Shorten very long filenames for display
                    const shortName = filename.length > 20 ? filename.substring(0, 18) + '‚Ä¶' : filename;
                    label.textContent = shortName;
                    label.title = filename;

                    div.appendChild(img);
                    div.appendChild(label);
                    grid.appendChild(div);
                });
            }

            // --- Update info panels ---
            function updateInfoPanels() {
                if (dotCode) {
                    dotCodePre.textContent = dotCode;
                    const encoded = encodeURIComponent(dotCode);
                    graphvizLink = `https://dreampuf.github.io/GraphvizOnline/?engine=dot#${encoded}`;
                    graphvizLinkInput.value = graphvizLink;
                } else {
                    dotCodePre.textContent = '(–∫–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)';
                    graphvizLinkInput.value = '(—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏)';
                }
                updatePhotosPanel();
            }

            // --- Build tree ---
            async function buildTree(peopleArray) {
                if (!peopleArray.length) return;
                people = peopleArray;
                showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...');
                await preloadPhotos(people);
                dotCode = generateDotCode(people);
                graphvizOnlineBtn.disabled = false;
                updateInfoPanels();
                showStatus('‚è≥ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞...');
                await renderDot(dotCode);
                showStatus('‚úÖ –î–µ—Ä–µ–≤–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ (—Å–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ —Ñ–æ—Ç–æ)');
            }

            async function loadFromUrl(url) {
                try {
                    showStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...');
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = parseExcel(await response.arrayBuffer());
                    await buildTree(data);
                } catch (e) {
                    showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, true);
                }
            }

            function loadFromFile(file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = parseExcel(e.target.result);
                        await buildTree(data);
                    } catch (err) {
                        showStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ' + err.message, true);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            loadBtn.addEventListener('click', () => loadFromUrl('tree.xlsx'));
            manualBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files[0]) loadFromFile(e.target.files[0]);
                fileInput.value = '';
            });

            graphvizOnlineBtn.addEventListener('click', () => {
                if (graphvizLink) window.open(graphvizLink, '_blank');
            });

            loadFromUrl('tree.xlsx');
        })();
    </script>
</body>
</html>
